<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Matrix Gui</title>
		<link rel="stylesheet" type="text/css" href="/css/matrix.css" ></link>		
		<script type="text/javascript" language="javascript" src="/scripts/jquery-1.6.1.min.js"></script>
		<script type="text/javascript" language="javascript" src="/scripts/jquery.clicknscroll.v1.0.cc_simple.js"></script>
		<script type="text/javascript" language="javascript" src="/scripts/dragscrollable.js"></script>
		<script type="text/javascript" language="javascript">
			var apps = [];
			var cache = [];
			var getUrlParam = function ( name ) {
				name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
				var regexS = "[\\?&]"+name+"=([^&#]*)";
				var regex = new RegExp( regexS );
				var results = regex.exec( window.location.href );
				if( results == null ) {
					return "";
				}else{
				    return results[1];
				}
			}
			var cleanAppPage = function(data){
				//HACK. This needs to be better implemented
				var start = data.indexOf('outputDiv') + "outputDiv".length + 2;
				var end = data.indexOf('/body') - 1;
				return data.substring(start, end);
			}
			var isInSubmenu = function(app, submenuCats){
				if(submenuCats == "" && !app.hasOwnProperty("categories")){
					return true;
				}else if(!app.hasOwnProperty("categories")){
					return false;
				}	
				var appCats = app.categories.toLowerCase().split(";");
				var sCats = submenuCats.toLowerCase().split(";");
				for(var i in sCats){
					for(var j in appCats){
						if(sCats[i] == appCats[j]){
							return true;
						}
					}
				}
				return false;
			}
			var updateAppStatus = function (id){
				var path = "/appstatus/" + id;
				console.log("fetching update");
				$.getJSON(path, function(data){
					if(data.output != ""){
						$("#apps").empty();
						var container = document.createElement("div");
						$(container).addClass("outputDiv");
						var p = document.createElement("pre");
						$(p).text(data.output);
						$(container).append(p);
						$("#apps").append(container);
						var bookend = document.createElement("div");
						$(bookend).attr("id", "bookend");
						$("#apps").append(bookend);
						var tgt = $(bookend);
						$('html,body').animate({scrollTop: tgt.offset().top}, 500);
					}
					if(data.running != false){
						setTimeout('updateAppStatus("'+id+'");', 500)
					}
				});
			}
			var launchApp = function(app){
				$.getJSON("/launch/" + app.path64, function(data, status){
					console.log(data);
					if(status == "success"){
						setTimeout('updateAppStatus("'+data.id+'");', 500);
					}
				});
			}
			var addApp = function (app){
				var container = document.createElement("div");
				var icon = document.createElement("img");
				icon.src = "/icons" + app.iconName;
				$(icon).addClass("app_icon");
				$(icon).attr("alt", "[ " + app.title + " ]"); 
				var t = document.createElement("p");
				$(t).text(app.title);				
				$(container).addClass("base");
				$(container).addClass("appContainer");
				if(app.appName == "Submenu"){
					$(container).click( function(){
							buildMenu(app.contents)
						});
				}else{
					$(container).click( function(){
						showAppDescription(app);
					});
				}
				$(container).append(icon);
				$(container).append(t);
				$("#apps").append(container);
			}
			var addRunBtn = function(app){
				$("#apps .runDiv").remove();
				if(app.hasOwnProperty("appName") && app.appName != ""){
					var runDiv = document.createElement("div");
					$(runDiv).addClass("runDiv");
					var runImg = document.createElement("img");
					$(runImg).attr("src", "/images/run-icon.png");
					$(runImg).addClass("runImg");
					$(runImg).attr("alt", "Run app");
					$(runDiv).append(runImg);
					$(runDiv).click(function(){
						launchApp(app);
					});
					$("#apps").append(runDiv);
				}
			}
			var showAppDescription = function(app){
				var cacheIndex = "app_" + app.path64;
				$("#apps").empty();
				if(cache.hasOwnProperty(cacheIndex)){
					$("#apps").append(cache[cacheIndex]);
					addRunBtn(app);
					return;
				}
				$.ajax("/app/" + app.path64,{ 
				"success" : function(data){
						var cleaned = '<div class="outputDiv">'+cleanAppPage(data) + '</div>';
						$("#apps").append(cleaned);
						addRunBtn(app);
						cache[cacheIndex] = cleaned;			
					}
				});
				$("#mainMenuBtn").css("display", "block");
			}
			var buildMenu = function(submenu){
				$("#apps").empty();
				if(cache.hasOwnProperty("menu_" + submenu)){
					for(var i in cache["menu_" + submenu]){
						addApp(cache["menu_" + submenu][i]);
					}
					return;
				}
				cache["menu_" + submenu] = [];
				for(var i in apps){
					var app = apps[i].Application;
					if(isInSubmenu(app, submenu)){
						addApp(app);
						cache["menu_" + submenu].push(app);
					}
				}
				if(submenu == ""){
					$("#mainMenuBtn").css("display", "none");
				}else{
					$("#mainMenuBtn").css("display", "block");
				}
			}
			window.onload = function(){
				$(document.body).clickNScroll();
			//	$("#matrixContainer").css("width", $(window).width());
			//	$("#matrixContainer").css("height", $(window).height());
			//	$("#matrixContainer").dragscrollable({dragSelector : "matrixContainer" });
				$.getJSON("/applist/", function( data ){
						apps = data;
						var menu = getUrlParam("menu");
						buildMenu(menu);
					});
				$("#mainMenuBtn").click(function(){
					buildMenu("");
					$("#mainMenuBtn").css("display", "none");
				});	
			}
		</script>
	</head>
	<body>
		<div id="matrixContainer">
			<div class="header">
				<a href="/clearcache/">
					<img alt="Texas Instruments" id="txlogo" class="tex" src="/images/header/tex.png">
				</a>
				<div class="title">Matrix Application Launcher</div>
				<img alt="Main Menu" id="mainMenuBtn" class="mainMenuBtn" src="/images/multi-icon.png">
			</div>
			<div id="apps" class="menuContainer">
				Your browser does not support javascript. Please click <a href="/menu/">here</a> for the html only menu. 
			</div>	
		</div>
	</body>
</html>

