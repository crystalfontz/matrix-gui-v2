<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Matrix Gui</title>
		<link rel="stylesheet" type="text/css" href="/css/matrix.css" ></link>		
		<script type="text/javascript" language="javascript" src="/scripts/jquery-1.6.1.min.js"></script>
		<script type="text/javascript" language="javascript" src="/scripts/jquery.swipe.js"></script>
		<script type="text/javascript" language="javascript">
			var apps = [];
			var cache = [];
			var appsPerPage = 10;
			var currentPage = false;
			var currentAppNum = 0;
			var lastSwipeTime = 0;
			var swipeInterval = 800;
			var nPages = 0;
			var showingPage = 0;
			var scrollLoc = 0;
			var allowPageSwipe = true;
			var smallScreen = false;
			var appsLoaded = 0;
			var getUrlParam = function ( name ) {
				name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
				var regexS = "[\\?&]"+name+"=([^&#]*)";
				var regex = new RegExp( regexS );
				var results = regex.exec( window.location.href );
				if( results == null ) {
					return "";
				}else{
				    return results[1];
				}
			}
			var getViewportHeight = function(){
				return $(window).height() -$("#navHeader").height();
			}
			var cleanAppPage = function(data){
				//HACK. This needs to be better implemented
				var start = data.indexOf('outputDiv') + "outputDiv".length + 2;
				var end = data.indexOf('/body') - 1;
				return data.substring(start, end);
			}
			var isInSubmenu = function(app, submenuCats){
				if(submenuCats == "" && !app.hasOwnProperty("categories")){
					return true;
				}else if(!app.hasOwnProperty("categories")){
					return false;
				}	
				var appCats = app.categories.toLowerCase().split(";");
				var sCats = submenuCats.toLowerCase().split(";");
				for(var i in sCats){
					for(var j in appCats){
						if(sCats[i] == appCats[j]){
							return true;
						}
					}
				}
				return false;
			}
			var updateAppStatus = function (id){
				var path = "/appstatus/" + id;
				$.getJSON(path, function(data){
					
						$("#apps").empty();
						var container = document.createElement("div");
						$(container).addClass("outputDiv");
						$(container).attr("id", "outputDiv");
						var p = document.createElement("pre");
						if(data.output != ""){
							$(p).html(data.output);
						}else{
							$(p).html("Application started, waiting for output.");
						}
						$(container).append(p);
						//$(container).text(escapeHtml(data.output));
						$("#apps").append(container);
						var bookend = document.createElement("div");
						$(bookend).attr("id", "bookend");
						$("#apps").append(bookend);
						var tgt = $(bookend);
						$('html,body').animate({scrollTop: tgt.offset().top}, 500);
						addOutputSwipe();
						$("#mainMenuBtn").css("display", "block");
					if(data.running != false){
						setTimeout('updateAppStatus("'+id+'");', 500)
					}
				});
			}
			var launchApp = function(app){
				$.getJSON("/launch/" + app.path64, function(data, status){
					if(status == "success"){
						setTimeout('updateAppStatus("'+data.id+'");', 500);
					}else{
						buildMenu("");
					}
				});
				$("#mainMenuBtn").css("display", "block");
			}
			var updatePages = function(){
				$(".page").css("display", "none");
				$("#page_"+ showingPage).css("display", "block");
			}
			var nextPage = function(){
				if(showingPage < nPages -1){
					showingPage ++;
					updatePages();
				}
			}
			var prevPage = function(){
				if(showingPage > 0){
					showingPage --;
					updatePages();
				}
			}
			var addPage = function(){
				currentPage = document.createElement("div");
				$(currentPage).addClass("page");
				$(currentPage).addClass("single");
				$(currentPage).attr("id", "page_" + nPages);
				$(currentPage).css("height", getViewportHeight());
				if(nPages != 0){
					$(currentPage).css("display", "none");
				}
				$("#menu").append(currentPage);
				currentAppNum = 0;
				nPages++;
			}
			var addApp = function (app){
				var container = document.createElement("div");
				var icon = document.createElement("img");
				icon.src = "/icons" + app.iconName;
				$(icon).addClass("app_icon");
				$(icon).attr("alt", "[ " + app.title + " ]"); 
				var t = document.createElement("p");
				$(t).text(app.title);				
				$(container).addClass("base");
				$(container).addClass("appContainer");
				if(app.appName == "Submenu"){
					$(icon).click( function(){
							buildMenu(app.contents)
						});
				}else{
					$(icon).click( function(){
						showAppDescription(app);
					});
				}
				$(container).append(icon);
				$(container).append(t);
				if(currentPage == false || currentAppNum >= appsPerPage){
					addPage();
				}
				$(currentPage).append(container);
				currentAppNum++;
			}
			var addRunBtn = function(app){
				$("#apps .runDiv").remove();
				if(app.hasOwnProperty("appName") && app.appName != ""){
					var runDiv = document.createElement("div");
					$(runDiv).addClass("runDiv");
					var runImg = document.createElement("img");
					$(runImg).attr("src", "/images/run-icon.png");
					$(runImg).addClass("runImg");
					$(runImg).attr("alt", "Run app");
					$(runDiv).append(runImg);
					$(runDiv).click(function(){
						$(runDiv).empty();
						$(runDiv).text("Launching Application");
						launchApp(app);
					});
					$("#apps").append(runDiv);
				}
			}
			var showAppDescription = function(app){
				var cacheIndex = "app_" + app.path64;
				$("#apps").empty();
				if(cache.hasOwnProperty(cacheIndex)){
					$("#apps").append(cache[cacheIndex]);
					addRunBtn(app);
				}else{
					$.ajax("/app/" + app.path64,{ 
					"success" : function(data){
							var cleaned = '<div class="outputDiv">'+cleanAppPage(data) + '</div>';
							$("#apps").append(cleaned);
							addRunBtn(app);
							cache[cacheIndex] = cleaned;			
						}
					});
				}
				$("#mainMenuBtn").css("display", "block");
			}
			var addMenuSwipe = function(){
				scrollLoc = $('html,body').scrollTop();
				$("#menu").swipe(function(dx, dy) {
					if(!allowPageSwipe){
						return;
					}
					if(Math.abs(dx) > 4 || Math.abs(dy) > 4){
						allowPageSwipe = false;
						var d = (Math.abs(dx) > Math.abs(dy) ) ? dx : dy;
						if(d > 0){
							prevPage();	
						}else{
							nextPage();	
						} 
						setTimeout(function(){
							allowPageSwipe=true;
							}, swipeInterval
						);
					}				
				}); 	
			}
			var scroll = function(dy){
				var maxScroll = $("#bookend").offset().top;
			/*	
				if(up){
					scrollLoc -= getViewportHeight() * .85;
				}else{
					scrollLoc += getViewportHeight() * .85;
				}
			*/
				scrollLoc -= (dy / 4) * getViewportHeight();	
			//	console.log("new scroll: " + scrollLoc + " max: " + maxScroll);
				if(scrollLoc > maxScroll) {
					scrollLoc = maxScroll;
				}else if(scrollLoc < 0){
					scrollLoc = 0;
				}
				$('html,body').animate({scrollTop: scrollLoc}, 200); 	
			}
			var addOutputSwipe = function(){
				$("#outputDiv").swipe(function(dx, dy) {
					if(Math.abs(dy) > 4){
						var now = (new Date()).getTime();
						if( now - lastSwipeTime >  swipeInterval){
						/*	if(dy > 0){
								scroll(true);
							}else{
								scroll(false);
							}
						*/
							scroll(dy);
							lastSwipeTime = now;
						}
					}				
				}); 	
			}
			var appCompare = function(a, b){
				var aHas = a.Application.hasOwnProperty("sortPriority");
				var bHas = b.Application.hasOwnProperty("sortPriority");
				if(aHas && !bHas){
					return -1;
				}
				if(bHas && !aHas){
					return 1;
				}
				if(aHas && bHas){
					var r = a.Application.sortPriority - b.Application.sortPriority;
					r /= Math.abs(r); //allows for < 1 difference in priority, while maintaining convention of -1/0/+1 for comparison
					if(r != 0){
						return r;
					}
				}
				var tA = a.Application.title.toLowerCase();
				var tB = b.Application.title.toLowerCase();
				if(tA == tB){
					return 0;
				}
				if(tA > tB){
					return 1;
				}
				return -1;
			}
			var buildMenu = function(submenu){
				$("#apps").empty();
				nPages = 0;
				showingPage = 0;
				currentPage = false;
				var menuDiv = document.createElement("div");
				$(menuDiv).attr("id", "menu");
				$("#apps").append(menuDiv);
				if(cache.hasOwnProperty("menu_" + submenu)){
					for(var i in cache["menu_" + submenu]){
						addApp(cache["menu_" + submenu][i]);
					}
				}else{
					cache["menu_" + submenu] = [];
					for(var i in apps){
						var app = apps[i].Application;
						if(isInSubmenu(app, submenu)){
							addApp(app);
							cache["menu_" + submenu].push(app);
						}
					}
				}
				if(submenu == ""){
					$("#mainMenuBtn").css("display", "none");
				}else{
					$("#mainMenuBtn").css("display", "block");
				}
				$('html,body').animate({scrollTop: 0}, 100);
				addMenuSwipe();
			}
			var setupCss = function(){
				var viewportHeight = $(window).height();
				if(viewportHeight < 400){
					var cssrule = "<style type='text/css'>";
					cssrule += ".app_icon{ width: 64px !important; height:64px !important}";
					cssrule += ".appContainer{ width: 115px !important; height: 108px !important}";
					cssrule += ".appTitle{font-size: 12px !important;}";
					cssrule += "</style>";
					$(cssrule).appendTo("head");
					smallScreen = true;
					return;	
				}
				smallScreen = false;				
			}
			var buildCache = function(){
				$("#txlogo").click(function(){return false;});
				appsLoaded = 0;
				$(apps).each(function(k, v){
					var app = v.Application;
					var cacheIndex = "app_" + app.path64;
					$.ajax("/app/" + app.path64,{ 
					"success" : function(data){
							var cleaned = '<div class="outputDiv">'+cleanAppPage(data) + '</div>';
							cache[cacheIndex] = cleaned;
							appsLoaded ++;
							var n = apps.length;
							$("#apps").empty();
							$("#apps").text(appsLoaded + " Applications cached of " + n);
							if(appsLoaded >= n){
								$("#apps").text("All applications loaded. Initializing menu.");
								setTimeout(function(){buildMenu(""); }, 3000);	
							}			
						}
					});
				});
			}
			window.onload = function(){				
				setupCss();
				var w = 155;
				var h = 140;
				if(smallScreen){
					w = 115;
					h = 108;
				}
				var winWidth = $(window).width();
				var winHeight = getViewportHeight();
				appsPerPage = Math.floor(winWidth / w) * Math.floor(winHeight / h);
			
				$.getJSON("/applist/", function( data ){
						apps = data;
						apps.sort(appCompare);
						var menu = getUrlParam("menu");
						buildMenu(menu);
					});
				$("#mainMenuBtn").click(function(){
					buildMenu("");
					$("#mainMenuBtn").css("display", "none");
				});
				$("#txlogo").click(buildCache);
				
			}
		</script>
	</head>
	<body>
		<div id="matrixContainer">
			<div class="header" id="navHeader">
				<img alt="Texas Instruments" id="txlogo" class="tex" src="/images/header/tex.png">
				<div class="title">Matrix Application Launcher</div>
				<img alt="Main Menu" id="mainMenuBtn" class="mainMenuBtn" src="/images/multi-icon.png">
			</div>
			<div id="apps" class="menuContainer">
				<h2>Loading Menu</h2>
				If this does not go away, your browser does not support javascript. Please click <a href="/menu/" style="font-weight:bold;">here</a> for the html only menu. 
			</div>	
		</div>
	</body>
</html>

